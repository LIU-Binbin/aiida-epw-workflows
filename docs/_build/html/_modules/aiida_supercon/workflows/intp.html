

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aiida_supercon.workflows.intp &mdash; aiida-epw 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=2389946f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            aiida-epw
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/modules.html">aiida_supercon</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">aiida-epw</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">aiida_supercon.workflows.intp</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for aiida_supercon.workflows.intp</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Work chain for computing the critical temperature based off an `EpwWorkChain`.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida</span><span class="w"> </span><span class="kn">import</span> <span class="n">orm</span><span class="p">,</span> <span class="n">load_profile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttributeDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkChain</span><span class="p">,</span> <span class="n">ToContext</span><span class="p">,</span> <span class="n">while_</span><span class="p">,</span> <span class="n">if_</span><span class="p">,</span> <span class="n">append_</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">,</span> <span class="n">calcfunction</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.workflows.protocols.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProtocolMixin</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.calculations.epw</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpwCalculation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.calculations.functions.create_kpoints_from_distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_kpoints_from_distance</span>


<span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpwBaseWorkChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.b2w</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpwB2WWorkChain</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<div class="viewcode-block" id="EpwBaseIntpWorkChain">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EpwBaseIntpWorkChain</span><span class="p">(</span><span class="n">ProtocolMixin</span><span class="p">,</span> <span class="n">WorkChain</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base work chain for two-step interpolation workflows.</span>
<span class="sd">    It will run the `EpwB2WWorkChain` for electron-phonon coupling matrix on Wannier representation.</span>
<span class="sd">    And then an `EpwBaseWorkChain` for interpolation from Wannier to Bloch representation (fine grid).</span>
<span class="sd">    Based on the fine-grid electron-phonon coupling matrix, various quantities can be computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Child classes should override these placeholders ---</span>
    <span class="n">_B2W_NAMESPACE</span> <span class="o">=</span> <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">_NAMESPACE</span>
    <span class="n">_INTP_NAMESPACE</span> <span class="o">=</span> <span class="s1">&#39;intp&#39;</span>  <span class="c1"># e.g., &#39;a2f&#39; for A2fWorkChain</span>
    <span class="c1"># ---------------------------------------------------------</span>

    <span class="n">_blocked_keywords</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;INPUTEPW&#39;</span><span class="p">,</span> <span class="s1">&#39;use_ws&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;INPUTEPW&#39;</span><span class="p">,</span> <span class="s1">&#39;nbndsub&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;INPUTEPW&#39;</span><span class="p">,</span> <span class="s1">&#39;bands_skipped&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;INPUTEPW&#39;</span><span class="p">,</span> <span class="s1">&#39;vme&#39;</span><span class="p">),</span>
    <span class="p">]</span>

<div class="viewcode-block" id="EpwBaseIntpWorkChain.define">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.define">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the work chain specification.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="c1"># TODO: Seems we don&#39;t need structure input port here</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">EpwB2WWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;populate_defaults&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Inputs for the interpolation `EpwCalculation`s.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># spec.inputs[cls._B2W_NAMESPACE].validator = None</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">EpwBaseWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;parent_folder_nscf&#39;</span><span class="p">,</span>
                <span class="s1">&#39;parent_folder_ph&#39;</span><span class="p">,</span>
                <span class="s1">&#39;parent_folder_chk&#39;</span><span class="p">,</span>
                <span class="c1"># &#39;parent_folder_epw&#39;,</span>
            <span class="p">),</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;populate_defaults&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Inputs for the a2f `EpwBaseWorkChain`.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">should_run_b2w</span><span class="p">)(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">run_b2w</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">inspect_b2w</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">prepare_process</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">run_process</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">inspect_process</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">results</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span>
            <span class="n">EpwB2WWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">,</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Outputs for the `EpwB2WWorkChain`.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span>
            <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;output_parameters&#39;</span><span class="p">,</span>
                <span class="s1">&#39;remote_folder&#39;</span><span class="p">,</span>
                <span class="s1">&#39;retrieved&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;output_parameters&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;remote_folder&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">RemoteData</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;retrieved&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">FolderData</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;ERROR_SUB_PROCESS_B2W&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The `B2W` sub process failed&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.get_descendant">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.get_descendant">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_descendant</span><span class="p">(</span>
        <span class="n">intp</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span>
        <span class="n">link_label_filter</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the descendant workchains of the intp workchain.</span>
<span class="sd">        :param intp: The intp workchain.</span>
<span class="sd">        :param link_label_filter: The link label filter.</span>
<span class="sd">        :return: The descendant workchain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">intp</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span>
                <span class="n">link_label_filter</span><span class="o">=</span><span class="n">link_label_filter</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">node</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.get_protocol_overrides">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.get_protocol_overrides">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protocol_overrides</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the ``overrides`` for default protocol.</span>
<span class="sd">        :return: The overrides.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">importlib_resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">protocols</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_builder_restart</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">from_intp_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs extracted from the intp workchain.</span>
<span class="sd">        This is a hook method for the `get_builder_restart` method of derived classes.</span>
<span class="sd">        :param from_intp_workchain: The intp workchain.</span>
<span class="sd">        :return: The builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">from_intp_workchain</span><span class="o">.</span><span class="n">get_builder_restart</span><span class="p">()</span>
        <span class="c1"># parent_builder = from_intp_workchain.get_builder_restart()</span>

        <span class="n">b2w</span> <span class="o">=</span> <span class="n">EpwBaseIntpWorkChain</span><span class="o">.</span><span class="n">get_descendant</span><span class="p">(</span>
            <span class="n">from_intp_workchain</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_intp_workchain</span><span class="o">.</span><span class="n">inputs</span>
            <span class="ow">or</span>
            <span class="n">b2w</span><span class="o">.</span><span class="n">is_finished_ok</span>
            <span class="p">):</span>

            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b2w_builder</span> <span class="o">=</span> <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">get_builder_restart</span><span class="p">(</span>
                <span class="n">from_b2w_workchain</span><span class="o">=</span><span class="n">b2w</span>
                <span class="p">)</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">b2w_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">intp</span> <span class="o">=</span> <span class="n">EpwBaseIntpWorkChain</span><span class="o">.</span><span class="n">get_descendant</span><span class="p">(</span>
            <span class="n">from_intp_workchain</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">intp</span> <span class="ow">and</span> <span class="n">intp</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The Workchain &lt;</span><span class="si">{</span><span class="n">from_intp_workchain</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">&gt; is already finished.&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_epw</span> <span class="o">=</span> <span class="n">intp</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_epw</span>

            <span class="k">return</span> <span class="n">builder</span>

<div class="viewcode-block" id="EpwBaseIntpWorkChain.get_builder_restart_from_b2w">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.get_builder_restart_from_b2w">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_restart_from_b2w</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">from_b2w_workchain</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs extracted from the b2w workchain.</span>
<span class="sd">        :param from_b2w_workchain: The b2w workchain.</span>
<span class="sd">        :param protocol: The protocol.</span>
<span class="sd">        :param overrides: The overrides.</span>
<span class="sd">        :return: The builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_protocol_inputs</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_b2w_workchain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">process_class</span> <span class="o">==</span> <span class="n">EpwB2WWorkChain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept `EpwB2WWorkChain`&#39;</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">][</span><span class="s1">&#39;epw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">code</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="k">if</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b2w_builder</span> <span class="o">=</span> <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">get_builder_restart</span><span class="p">(</span>
                <span class="n">from_b2w_workchain</span><span class="o">=</span><span class="n">from_b2w_workchain</span><span class="p">,</span>
                <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
                <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

            <span class="c1"># Actually there is no exclusion of EpwB2WWorkChain namespace</span>
            <span class="c1"># So we need to set the _data manually</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">b2w_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">intp_builder</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="n">intp_builder</span><span class="o">.</span><span class="n">parent_folder_epw</span> <span class="o">=</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">intp_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">clean_workdir</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;clean_workdir&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.get_builder_from_protocol">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.get_builder_from_protocol">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_from_protocol</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">codes</span><span class="p">,</span>
            <span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs selected according to the chosen protocol.</span>
<span class="sd">        :param codes: The codes should be a dictionary with the following keys:</span>
<span class="sd">            - pw: The code for the pw.x calculation.</span>
<span class="sd">            - ph: The code for the ph.x calculation.</span>
<span class="sd">            - epw: The code for the epw.x calculation.</span>
<span class="sd">            - pw2wannier90: The code for the pw2wannier90.x calculation.</span>
<span class="sd">            - wannier: The code for the wannier90.x calculation.</span>
<span class="sd">        :param structure: The structure.</span>
<span class="sd">        :param protocol: The protocol.</span>
<span class="sd">        :param overrides: The overrides.</span>
<span class="sd">        :return: The builder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_protocol_inputs</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="n">b2w_builder</span> <span class="o">=</span> <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># b2w_builder.w90_intp.pop(&#39;open_grid&#39;)</span>
        <span class="c1"># b2w_builder.w90_intp.pop(&#39;projwfc&#39;)</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">b2w_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">intp_builder</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">codes</span><span class="p">[</span><span class="s1">&#39;epw&#39;</span><span class="p">],</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">intp_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">clean_workdir</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;clean_workdir&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.setup">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup steps, i.e. initialise context variables.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">degaussq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">EpwBaseWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="p">)</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.should_run_b2w">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.should_run_b2w">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_run_b2w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the epw loop should continue or not.</span>
<span class="sd">        If &#39;intp&#39; is not in the inputs, it will return False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.run_b2w">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.run_b2w">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_b2w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the ``restart`` EPW calculation for the current interpolation distance.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running B2W...&#39;</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">EpwB2WWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="p">)</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">call_link_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span>
        <span class="n">workchain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">EpwB2WWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;launching `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span><span class="si">}</span><span class="s1">` with PK </span><span class="si">{</span><span class="n">workchain_node</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_b2w</span><span class="o">=</span><span class="n">workchain_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.inspect_b2w">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.inspect_b2w">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inspect_b2w</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the epw.x workflow finished successfully.</span>
<span class="sd">        If the epw workflow passed, it will generate the parent folder for the following EpwBaseWorkChain.</span>
<span class="sd">        It will expose the outputs of the EpwB2WWorkChain as an intermediate results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">b2w_workchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_b2w</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">b2w_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`epw.x` failed with exit status </span><span class="si">{</span><span class="n">b2w_workchain</span><span class="o">.</span><span class="n">exit_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">ERROR_SUB_PROCESS_B2W</span>

        <span class="c1"># We set the parent folder here to keep the logic of restart from EpwB2WWorkChain</span>
        <span class="c1"># Since the only connection between the EpwBaseIntpWorkChain and EpwB2WWorkChain is the parent_folder_epw</span>
        <span class="c1"># And the parameter of EpwB2WWorkChain is deduced from the parent_folder_epw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_epw</span> <span class="o">=</span> <span class="n">b2w_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_b2w</span><span class="p">,</span>
                <span class="n">EpwB2WWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_B2W_NAMESPACE</span>
                <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.prepare_process">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.prepare_process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare for the `EpwBaseWorkChain` workchain.</span>
<span class="sd">        It will update the parameters of the EpwBaseWorkChain with the parameters of the previous EpwB2WWorkChain.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

        <span class="n">b2w_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_epw</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocked_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">b2w_parameters</span><span class="p">[</span><span class="n">namespace</span><span class="p">]:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">b2w_parameters</span><span class="p">[</span><span class="n">namespace</span><span class="p">][</span><span class="n">keyword</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span></div>



<div class="viewcode-block" id="EpwBaseIntpWorkChain.run_process">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.run_process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the `EpwBaseWorkChain`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">call_link_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span>
        <span class="n">workchain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">EpwBaseWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;launching `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span><span class="si">}</span><span class="s1">` with PK </span><span class="si">{</span><span class="n">workchain_node</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_intp</span><span class="o">=</span><span class="n">workchain_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.results">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;It will expose the basic outputs of the `EpwBaseWorkChain` as a final results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_intp</span><span class="p">,</span>
                <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_INTP_NAMESPACE</span>
                <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;output_parameters&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_intp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">output_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;remote_folder&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_intp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="s1">&#39;retrieved&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_intp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">retrieved</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwBaseIntpWorkChain.on_terminated">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.intp.EpwBaseIntpWorkChain.on_terminated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_terminated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the work chain.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_terminated</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">clean_workdir</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;remote folders will not be cleaned&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">cleaned_calcs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">called_descendant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">called_descendants</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">called_descendant</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">called_descendant</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>  <span class="c1"># pylint: disable=protected-access</span>
                    <span class="n">cleaned_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">called_descendant</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">cleaned_calcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cleaned remote folders of calculations: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">cleaned_calcs</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Marnik Bercx.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>