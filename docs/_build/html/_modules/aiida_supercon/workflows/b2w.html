

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aiida_supercon.workflows.b2w &mdash; aiida-epw 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=2389946f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            aiida-epw
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference/modules.html">aiida_supercon</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">aiida-epw</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">aiida_supercon.workflows.b2w</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for aiida_supercon.workflows.b2w</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Work chain to compute the electron-phonon coupling.</span>

<span class="sd">This work chain is refined to accept the parent folders of the Wannier90 and Phonon work chains.</span>

<span class="sd">Firstly it will validate the parent folders.</span>

<span class="sd">- If the phonon parent folders are valid, it will use the qpoints from the phonon parent folders.</span>

<span class="sd">Then it will check if the wannier90 parent folders are valid.</span>

<span class="sd">- If so, it will check if the kpoints of the wannier90 work chain are compatible with the qpoints of the phonon work chain.</span>

<span class="sd">- If they are not compatible, it will re-generate the kpoints of the wannier90 work chain based on the qpoints of the phonon work chain. Then it will re-run the wannier90 work chain.</span>

<span class="sd">- If the wannier90 parent folders are not valid, it will run the wannier90 work chain from scratch.</span>

<span class="sd">If none of the parent folders are provided or are not valid, it will run the Wannier90 and Phonon work chains from scratch.</span>

<span class="sd">The first step is to compute the electron-phonon (dvscf) on a coarse grid. I think 0.3A^-1 q-point grid should be good but you can use the same k-point grid (as opposed to twice) so it should be cheaper. This step should be done only once</span>

<span class="sd">For this step you need to run</span>

<span class="sd">pw.x &lt; scf.in</span>
<span class="sd">ph.x &lt; ph.in</span>

<span class="sd">Once the calculation is done, you need to rename and gather the results in a &quot;save&quot; folder</span>
<span class="sd">This is done with QE/EPW/bin/pp.py script</span>
<span class="sd">You just run it as python3 QE/EPW/bin/pp.py</span>
<span class="sd">you need to provide the prefix name to the script</span>
<span class="sd">What is very important is that the &quot;save&quot; folder is saved in the AiiDA framework</span>
<span class="sd">This will be the biggest thing to save and is typically ~ 500 mb to 1 Gb</span>

<span class="sd">We can discuss this if we want to keep it or not but if possible, I would say yes</span>
<span class="sd">Ok then the EPW step starts</span>

<span class="sd">2. Find initial wannier projection</span>

<span class="sd">pw.x &lt; scf.in</span>
<span class="sd">pw.x &lt; nscf.in</span>
<span class="sd">projwfc.x</span>
<span class="sd">+ wannier steps from Junfeng workflow?</span>
<span class="sd">-&gt; What we need here is the block of inputs provided to epw.in linked to the wannierization</span>
<span class="sd">(wdata(1) = &quot;&lt;wannier inputs&gt;&quot; input variable; is basically a vector of input variables that are directly passed to wannier.x)</span>

<span class="sd">e.g.</span>

<span class="sd"> wdata(1) = &#39;bands_plot = .true.&#39;</span>
<span class="sd"> wdata(2) = &#39;begin kpoint_path&#39;</span>
<span class="sd"> wdata(3) = &#39;G 0.00 0.00 0.00 M 0.50 0.00 0.00&#39;</span>
<span class="sd"> wdata(4) = &#39;M 0.50 0.00 0.00 K 0.333333333333 0.333333333333 0.00&#39;</span>
<span class="sd"> wdata(5) = &#39;K 0.333333333333 0.333333333333 0.00 G 0.0 0.0 0.00&#39;</span>
<span class="sd"> wdata(6) = &#39;end kpoint_path&#39;</span>
<span class="sd"> wdata(7) = &#39;bands_plot_format = gnuplot&#39;</span>
<span class="sd"> wdata(8) = &#39;dis_num_iter      = 5000&#39;</span>
<span class="sd"> wdata(9) = &#39;num_print_cycles  = 10&#39;</span>
<span class="sd"> wdata(10) = &#39;dis_mix_ratio     = 1.0&#39;</span>
<span class="sd"> wdata(11) = &#39;conv_tol = 1E-12&#39;</span>
<span class="sd"> wdata(12) = &#39;conv_window = 4&#39;</span>


<span class="sd">3. EPW step (in a different folder). You just need to do a soft link to the &quot;save&quot; folder from the above step</span>

<span class="sd">You need to do</span>
<span class="sd">pw.x &lt;scf.in   (Could potentially be the same as in step 2)</span>
<span class="sd">pw.x &lt;nscf.in -&gt; JQ: we can simply use these from the wannier workflow</span>

<span class="sd">epw.x &lt; epw1.in</span>

<span class="sd">At the end of this step, you have the electron-phonon matrix element in real space</span>
<span class="sd">This needs to be stored for sure</span>
<span class="sd">The most important and only big file is &quot;PREFIX..epmatwp&quot;</span>
<span class="sd">For TiO, this is 872 Mb ...</span>
<span class="sd">From this file you can interpolate to any fine grid density</span>

<span class="sd">I mean use for next calculation but you may want to keep it in order to do more convergence later</span>
<span class="sd">for example if you find that a 40x40x40 grid is not enough</span>
<span class="sd">you dont want to redo step 1 and 2 to get 60x60x60</span>

<span class="sd">Files to save:</span>

<span class="sd">ln -s ../epw8-conv1/crystal.fmt</span>
<span class="sd">ln -s ../epw8-conv1/epwdata.fmt</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.bvec</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.chk</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.kgmap</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.kmap</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.mmn</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.nnkp</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.ukk</span>
<span class="sd">ln -s ../epw8-conv1/&lt;prefix&gt;.epmatwp (Note: quite big file!)</span>
<span class="sd">ln -s ../epw8-conv1/vmedata.fmt</span>
<span class="sd">ln -s ../epw8-conv1/dmedata.fmt</span>
<span class="sd">ln -s ../epw8-conv1/save (Is basically the save folder from step 1)</span>

<span class="sd">4. EPW interpolation to get Eliashberg Tc</span>

<span class="sd">epw.x &lt; epw2.in</span>
<span class="sd">epw2.in</span>

<span class="sd">and basically here you can change the fine grid in epw2.in to converge things</span>
<span class="sd">This run can be done in a different folder but you need to soft link a number of files from the previous calculation 2.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida</span><span class="w"> </span><span class="kn">import</span> <span class="n">orm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">AttributeDict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">PortNamespace</span><span class="p">,</span> <span class="n">ProcessBuilder</span><span class="p">,</span> <span class="n">WorkChain</span><span class="p">,</span> <span class="n">ToContext</span><span class="p">,</span> <span class="n">if_</span><span class="p">,</span> <span class="n">while_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.workflows.ph.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">PhBaseWorkChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.workflows.pw.bands</span><span class="w"> </span><span class="kn">import</span> <span class="n">PwBandsWorkChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.workflows.protocols.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProtocolMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida.orm.nodes.data.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_aiida_type</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.calculations.functions.create_kpoints_from_distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_kpoints_from_distance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.utils.mapping</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_process_inputs</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_wannier90_workflows.workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wannier90BaseWorkChain</span><span class="p">,</span> <span class="n">Wannier90BandsWorkChain</span><span class="p">,</span> <span class="n">Wannier90OptimizeWorkChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_wannier90_workflows.workflows.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_inputs</span> <span class="k">as</span> <span class="n">validate_inputs_w90</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_wannier90_workflows.utils.workflows.builder.setter</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_kpoints</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiida_wannier90_workflows.common.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">WannierProjectionType</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.utils.kpoints</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_compatible</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpwBaseWorkChain</span>


<div class="viewcode-block" id="EpwB2WWorkChain">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EpwB2WWorkChain</span><span class="p">(</span><span class="n">ProtocolMixin</span><span class="p">,</span> <span class="n">WorkChain</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main work chain that orchestrates the `Wannier90OptimizeWorkChain`, `PhBaseWorkChain` and `EpwBaseWorkChain`.</span>

<span class="sd">    This work chain is designed to transform the electron-phonon matrix from the Bloch basis (coarse grid) to the Wannier basis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_QFPOINTS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">_KFPOINTS_FACTOR</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">SOURCE_LIST</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;ph_base&#39;</span><span class="p">:[</span>
            <span class="s1">&#39;DYN_MAT/dynamical-matrix-*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;out/_ph0/aiida.dvscf1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;out/_ph0/aiida.q_*/aiida.dvscf1&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="s1">&#39;epw&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;crystal.fmt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dmedata.fmt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;epwdata.fmt&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;selecq.fmt&#39;,</span>
            <span class="s1">&#39;dmedata.fmt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;aiida.kgmap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;aiida.kmap&#39;</span><span class="p">,</span>
            <span class="s1">&#39;aiida.ukk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;out/aiida.epmatwp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;save&#39;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="n">_NAMESPACE</span> <span class="o">=</span> <span class="s1">&#39;b2w&#39;</span>
    <span class="n">_W90_NAMESPACE</span> <span class="o">=</span> <span class="s1">&#39;w90_intp&#39;</span>
    <span class="n">_PH_NAMESPACE</span> <span class="o">=</span> <span class="s1">&#39;ph_base&#39;</span>
    <span class="n">_EPW_NAMESPACE</span> <span class="o">=</span> <span class="s1">&#39;epw&#39;</span>

    <span class="n">_NAMESPACE_LIST</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_W90_NAMESPACE</span><span class="p">,</span> <span class="n">_PH_NAMESPACE</span><span class="p">,</span> <span class="n">_EPW_NAMESPACE</span><span class="p">]</span>

<div class="viewcode-block" id="EpwB2WWorkChain.validate_inputs">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.validate_inputs">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_inputs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the inputs of the entire input namespace of `Wannier90OptimizeWorkChain`.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">):</span>
            <span class="n">validate_inputs_w90</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.define">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.define">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">define</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the work chain specification.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;structure&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">StructureData</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;kpoints_factor_nscf&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;qpoints_distance&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s1">&#39;qpoints&#39;</span><span class="p">,</span> <span class="n">valid_type</span><span class="o">=</span><span class="n">orm</span><span class="o">.</span><span class="n">KpointsData</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">Wannier90OptimizeWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nscf.kpoints&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nscf.kpoints_distance&#39;</span>
            <span class="p">),</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;populate_defaults&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Inputs for the `Wannier90OptimizeWorkChain/Wannier90BandsWorkChain`.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">PhBaseWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;qpoints&#39;</span><span class="p">,</span>
                <span class="s1">&#39;qpoints_distance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ph.parent_folder&#39;</span>
            <span class="p">),</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;populate_defaults&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Inputs for the `PwBaseWorkChain` that does the `ph.x` calculation.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_inputs</span><span class="p">(</span>
            <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span>
            <span class="n">exclude</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_workdir&#39;</span><span class="p">,</span>
                <span class="s1">&#39;qfpoints_distance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;qfpoints&#39;</span><span class="p">,</span>
                <span class="s1">&#39;kfpoints&#39;</span><span class="p">,</span>
                <span class="s1">&#39;kfpoints_factor&#39;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;populate_defaults&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Inputs for the `EpwBaseWorkChain` that does the `epw.x` calculation.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># spec.inputs[cls._EPW_NAMESPACE].validator = cls.validate_inputs</span>
        <span class="c1"># spec.inputs.validator = cls.validate_inputs</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span>
            <span class="n">Wannier90OptimizeWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">,</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;Outputs from the `Wannier90OptimizeWorkChain`.&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span>
            <span class="n">PhBaseWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">,</span>
            <span class="n">namespace_options</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">expose_outputs</span><span class="p">(</span>
            <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">spec</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">generate_reciprocal_points</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">setup</span><span class="p">,</span>
            <span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">should_run_wannier90</span><span class="p">)(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">run_wannier90</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">inspect_wannier90</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">if_</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">should_run_ph</span><span class="p">)(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">run_ph</span><span class="p">,</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">inspect_ph</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">run_epw</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">inspect_epw</span><span class="p">,</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="s1">&#39;ERROR_SUB_PROCESS_FAILED_BANDS&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The `PwBandsWorkChain` sub process failed&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">402</span><span class="p">,</span> <span class="s1">&#39;ERROR_SUB_PROCESS_FAILED_WANNIER90&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The `Wannier90BandsWorkChain` sub process failed&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s1">&#39;ERROR_SUB_PROCESS_FAILED_PHONON&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The electron-phonon `PhBaseWorkChain` sub process failed&#39;</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">exit_code</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;ERROR_SUB_PROCESS_FAILED_EPW&#39;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The `EpwWorkChain` sub process failed&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_protocol_filepath">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_protocol_filepath">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protocol_filepath</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``pathlib.Path`` to the ``.yaml`` file that defines the protocols.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">importlib_resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">protocols</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_NAMESPACE</span><span class="si">}</span><span class="s1">.yaml&#39;</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_protocol_overrides">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_protocol_overrides">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protocol_overrides</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the ``overrides`` of the default protocol.&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">importlib_resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">protocols</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">files</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_NAMESPACE</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>



    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">namespace_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the list of namespaces within this work chain.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NAMESPACE_LIST</span>

<div class="viewcode-block" id="EpwB2WWorkChain.set_target_base">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.set_target_base">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_target_base</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">target_base_prefix</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;We stash the outputs of PhBaseWorkChain and EpwBaseWorkChain for possible restart purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;stash&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]:</span>
            <span class="n">computer</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">computer</span>
            <span class="k">if</span> <span class="n">computer</span><span class="o">.</span><span class="n">transport_type</span> <span class="o">==</span> <span class="s1">&#39;core.local&#39;</span><span class="p">:</span>
                <span class="n">target_basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">computer</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_base_prefix</span><span class="si">}</span><span class="s1">-stash&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">computer</span><span class="o">.</span><span class="n">transport_type</span> <span class="o">==</span> <span class="s1">&#39;core.ssh&#39;</span><span class="p">:</span>
                <span class="n">target_basepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                    <span class="n">computer</span><span class="o">.</span><span class="n">get_workdir</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">computer</span><span class="o">.</span><span class="n">get_configuration</span><span class="p">()[</span><span class="s1">&#39;username&#39;</span><span class="p">]),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_base_prefix</span><span class="si">}</span><span class="s1">-stash&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

            <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">][</span><span class="s1">&#39;stash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;target_base&#39;</span><span class="p">:</span> <span class="n">target_basepath</span><span class="p">,</span>
                <span class="s1">&#39;source_list&#39;</span><span class="p">:</span> <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">SOURCE_LIST</span><span class="p">[</span><span class="n">target_base_prefix</span><span class="p">]</span>
                <span class="p">}</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_descendant_workchain">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_descendant_workchain">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_descendant_workchain</span><span class="p">(</span>
        <span class="n">b2w</span><span class="p">:</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">,</span>
        <span class="n">link_label_filter</span><span class="p">:</span> <span class="nb">str</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">orm</span><span class="o">.</span><span class="n">WorkChainNode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses a completed EpwB2WWorkChain node and extracts its</span>
<span class="sd">        successful sub-workchain nodes.</span>

<span class="sd">        :param b2w: A finished and successful EpwB2WWorkChain node.</span>
<span class="sd">        :param link_label_filter: The link label of the sub-workchain to be extracted.</span>
<span class="sd">        :return: The sub-workchain node.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find the sub-workchains from the outputs (or links).</span>
        <span class="c1"># The exact way to get them depends on how you defined the call_link_labels in b2w&#39;s outline.</span>
        <span class="c1"># Let&#39;s assume the call links are &#39;w90_intp&#39;, &#39;ph_base&#39;, and &#39;epw&#39;.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get_outgoing() returns a list of links, we get the first one&#39;s node</span>
            <span class="n">descendant</span> <span class="o">=</span> <span class="n">b2w</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">get_outgoing</span><span class="p">(</span>
                <span class="n">link_label_filter</span><span class="o">=</span><span class="n">link_label_filter</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">node</span>
            <span class="k">return</span> <span class="n">descendant</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># ValueError is raised by .one() if it doesn&#39;t find exactly one link</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find a unique sub-workflow with link label &#39;</span><span class="si">{</span><span class="n">link_label_filter</span><span class="si">}</span><span class="s2">&#39; in &lt;</span><span class="si">{</span><span class="n">b2w</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span></div>



<div class="viewcode-block" id="EpwB2WWorkChain.get_builder_restart">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_builder_restart">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_restart</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">from_b2w_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">ProcessBuilder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs extracted from the previous EpwB2WWorkChain.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.overrides</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span>

        <span class="c1"># Firstly check if the previous EpwB2WWorkChain is finished_ok</span>

        <span class="k">if</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">process_class</span> <span class="o">!=</span> <span class="n">EpwB2WWorkChain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node &lt;</span><span class="si">{</span><span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">&gt; is not of type EpwB2WWorkChain.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is no reason to restart a finished `EpwB2WWorkChain`&#39;</span><span class="p">)</span>


        <span class="c1"># If a previous EpwB2WWorkChain is provided, use it to populate the builder</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">get_builder_restart</span><span class="p">()</span>

        <span class="c1"># Firstly get descendants of the previous EpwB2WWorkChain</span>
        <span class="c1"># Then check if the previous EpwB2WWorkChain is finished_ok</span>

        <span class="c1"># Get the wannier90 workchain</span>
        <span class="n">from_w90_workchain</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_descendant_workchain</span><span class="p">(</span>
                <span class="n">from_b2w_workchain</span><span class="p">,</span>
                <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span>
                <span class="p">)</span>

        <span class="c1"># The logic here is: if there is not w90 namespace in the previous workchain, the workchain must have been restarted that the wannier90 workchain is popped,</span>
        <span class="c1"># or there is one but it is finished_ok, we don&#39;t need to restart either.</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">)</span>

            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_nscf</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">parent_folder_nscf</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_chk</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">epw</span><span class="o">.</span><span class="n">parent_folder_chk</span>

        <span class="k">elif</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">)</span>

            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">remote_folder</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_nscf</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">nscf</span><span class="o">.</span><span class="n">remote_folder</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_chk</span> <span class="o">=</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span><span class="p">(</span><span class="n">from_w90_workchain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">_data</span>
            <span class="c1"># The logic here is: if there is not ph namespace in the previous workchain, it must have been restarted that the phonon workchain is popped,</span>
            <span class="c1"># or there is one but it is finished_ok, we don&#39;t need to restart either.</span>

        <span class="n">from_ph_workchain</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_descendant_workchain</span><span class="p">(</span>
                <span class="n">from_b2w_workchain</span><span class="p">,</span>
                <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">)</span>

            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_ph</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="k">elif</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">)</span>

            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">parent_folder_ph</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">_data</span>

        <span class="c1"># Get the epw workchain</span>
        <span class="n">from_epw_workchain</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_descendant_workchain</span><span class="p">(</span>
            <span class="n">from_b2w_workchain</span><span class="p">,</span>
            <span class="n">EpwB2WWorkChain</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">from_epw_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The `EpwB2WWorkChain` &lt;</span><span class="si">{</span><span class="n">from_b2w_workchain</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">&gt; is already finished.&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_builder_restart_from_phonon">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_builder_restart_from_phonon">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_restart_from_phonon</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">codes</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">from_ph_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">ProcessBuilder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs according to the previous PhBaseWorkChain and protocol for other namespaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">process_label</span> <span class="o">!=</span> <span class="s1">&#39;PhBaseWorkChain&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept a finished `PhBaseWorkChain`&#39;</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_protocol_inputs</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">aiida_quantumespresso.calculations.pw</span><span class="w"> </span><span class="kn">import</span> <span class="n">PwCalculation</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_ph_workchain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept a finished `PhBaseWorkChain`&#39;</span><span class="p">)</span>

        <span class="c1"># builder = cls.get_builder()</span>
        <span class="c1"># builder.pop(cls._PH_NAMESPACE)</span>

        <span class="c1"># Currently we assume that the parent folder is created by a `PwCalculation`</span>
        <span class="c1"># So a StructureData is always associated with it.</span>
        <span class="c1"># If the creator is not a `PwCalculation`, we raise an error.</span>

        <span class="n">parent_calcjob</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span><span class="o">.</span><span class="n">creator</span>

        <span class="k">if</span> <span class="n">parent_calcjob</span><span class="o">.</span><span class="n">process_label</span> <span class="o">!=</span> <span class="s1">&#39;PwCalculation&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot find the structure associated with this `PhBaseWorkChain`&#39;</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">parent_calcjob</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">)</span>
        <span class="c1"># builder.structure = structure</span>
        <span class="c1"># w90_intp = Wannier90OptimizeWorkChain.get_builder_from_protocol(</span>
        <span class="c1">#     codes=codes,</span>
        <span class="c1">#     structure=structure,</span>
        <span class="c1">#     protocol=protocol,</span>
        <span class="c1">#     overrides=inputs.get(cls._W90_NAMESPACE, {}),</span>
        <span class="c1">#     pseudo_family=inputs.get(cls._W90_NAMESPACE, {}).get(&#39;pseudo_family&#39;, None),</span>
        <span class="c1">#     projection_type=kwargs.get(&#39;wannier_projection_type&#39;, WannierProjectionType.ATOMIC_PROJECTORS_QE),</span>
        <span class="c1">#     reference_bands=kwargs.get(&#39;reference_bands&#39;, None),</span>
        <span class="c1">#     bands_kpoints=kwargs.get(&#39;bands_kpoints&#39;, None),</span>
        <span class="c1"># )</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;projwfc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;open_grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># builder[cls._W90_NAMESPACE]._data = w90_intp._data</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">optimize_disproj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">epw_builder</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">codes</span><span class="p">[</span><span class="s1">&#39;epw&#39;</span><span class="p">],</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_ph</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">epw_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="k">if</span> <span class="s1">&#39;qpoints_distance&#39;</span> <span class="ow">in</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">qpoints_distance</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">qpoints_distance</span><span class="p">)</span>

        <span class="c1"># builder.kpoints_factor_nscf = orm.Int(inputs.get(&#39;kpoints_factor_nscf&#39;))</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_builder_restart_from_wannier90">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_builder_restart_from_wannier90">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_restart_from_wannier90</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">codes</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">from_w90_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">ProcessBuilder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs according to the previous Wannier90OptimizeWorkChain and protocol for other namespaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.overrides</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_protocol_inputs</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_w90_workchain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept a finished `Wannier90OptimizeWorkChain`&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">nscf</span><span class="o">.</span><span class="n">remote_folder</span><span class="o">.</span><span class="n">is_cleaned</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;The `nscf` remote folder is clean. &#39;</span>
                <span class="s1">&#39;Why not restart from scratch?&#39;</span><span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">qpoints_distance</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;qpoints_distance&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">kpoints_factor_nscf</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;kpoints_factor_nscf&#39;</span><span class="p">])</span>

        <span class="n">ph_base</span> <span class="o">=</span> <span class="n">PhBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">codes</span><span class="p">[</span><span class="s1">&#39;ph&#39;</span><span class="p">],</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="n">ph_base</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="c1"># NOTE: It&#39;s not good to use internal ._data property but it&#39;s quite convenient here</span>
        <span class="c1"># Because for first-time running, we can&#39;t provide the parent scf folder so normally we should exclude it from ph_base namespace</span>
        <span class="c1"># But if we restart from a finished wannier90 workchain we can provide it so it should not be excluded.</span>
        <span class="c1"># TODO: Find a better way to do this</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">ph_base</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">epw_builder</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">codes</span><span class="p">[</span><span class="s1">&#39;epw&#39;</span><span class="p">],</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_nscf</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">nscf</span><span class="o">.</span><span class="n">remote_folder</span>
        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_chk</span> <span class="o">=</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span><span class="p">(</span><span class="n">from_w90_workchain</span><span class="p">)</span>
        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">epw_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_builder_from_wannier90_and_phonon">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_builder_from_wannier90_and_phonon">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_from_wannier90_and_phonon</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">from_w90_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">from_ph_workchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">ProcessBuilder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs according to the previous Wannier90OptimizeWorkChain and PhBaseWorkChain and protocol for other namespaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.overrides</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_w90_workchain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept a finished `Wannier90OptimizeWorkChain`&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_ph_workchain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently we only accept a finished `PhBaseWorkChain`&#39;</span><span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;qpoints&#39;</span> <span class="ow">in</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">qpoints</span>
        <span class="k">elif</span> <span class="s1">&#39;qpoints_distance&#39;</span> <span class="ow">in</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">qpoints_distance</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">qpoints_distance</span><span class="p">)</span>

        <span class="n">epw_builder</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">builder</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_nscf</span> <span class="o">=</span> <span class="n">from_w90_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">nscf</span><span class="o">.</span><span class="n">remote_folder</span>
        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_chk</span> <span class="o">=</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span><span class="p">(</span><span class="n">from_w90_workchain</span><span class="p">)</span>
        <span class="n">epw_builder</span><span class="o">.</span><span class="n">parent_folder_ph</span> <span class="o">=</span> <span class="n">from_ph_workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">epw_builder</span><span class="o">.</span><span class="n">_data</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.get_builder_from_protocol">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.get_builder_from_protocol">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_builder_from_protocol</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wannier_projection_type</span><span class="o">=</span><span class="n">WannierProjectionType</span><span class="o">.</span><span class="n">ATOMIC_PROJECTORS_QE</span><span class="p">,</span>
        <span class="n">w90_chk_to_ukk_script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">band_kpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span><span class="o">-&gt;</span> <span class="n">ProcessBuilder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a builder prepopulated with inputs according to the previous Wannier90OptimizeWorkChain and PhBaseWorkChain and protocol for other namespaces.</span>
<span class="sd">        :param codes: A dictionary of codes for the different calculations. Should be in the following format:</span>
<span class="sd">            {</span>
<span class="sd">                &#39;pw&#39;: code pw.x,</span>
<span class="sd">                &#39;ph&#39;: code ph.x,</span>
<span class="sd">                &#39;epw&#39;: code epw.x,</span>
<span class="sd">                &#39;pw2wannier90&#39;: code pw2wannier90.x,</span>
<span class="sd">                &#39;wannier&#39;: code wannier90.x,</span>
<span class="sd">            }</span>
<span class="sd">        :param structure: the ``StructureData`` instance to use.</span>
<span class="sd">        :param protocol: protocol to use, if not specified, the default will be used.</span>
<span class="sd">        :param overrides: optional dictionary of inputs to override the defaults of the protocol.</span>
<span class="sd">        :param kwargs: additional keyword arguments that will be passed to the ``get_builder_from_protocol`` of all the</span>
<span class="sd">            sub processes that are called by this workchain.</span>
<span class="sd">        :return: a process builder instance with all inputs defined ready for launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_protocol_inputs</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">overrides</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_builder</span><span class="p">()</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">qpoints_distance</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;qpoints_distance&#39;</span><span class="p">])</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">kpoints_factor_nscf</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;kpoints_factor_nscf&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">band_kpoints</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">band_kpoints</span> <span class="o">=</span> <span class="n">band_kpoints</span>
        <span class="c1"># Set up the wannier90 sub-workchain</span>
        <span class="n">w90_intp_inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">pseudo_family</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pseudo_family&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">w90_intp</span> <span class="o">=</span> <span class="n">Wannier90OptimizeWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">codes</span><span class="o">=</span><span class="n">codes</span><span class="p">,</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">w90_intp_inputs</span><span class="p">,</span>
            <span class="n">pseudo_family</span><span class="o">=</span><span class="n">pseudo_family</span><span class="p">,</span>
            <span class="n">projection_type</span><span class="o">=</span><span class="n">wannier_projection_type</span><span class="p">,</span>
            <span class="n">print_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">w90_intp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;projwfc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">w90_intp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;open_grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># TODO: Only for testing, will remove later</span>
        <span class="n">w90_intp</span><span class="o">.</span><span class="n">optimize_disproj</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">w90_intp</span><span class="o">.</span><span class="n">_data</span>

        <span class="c1"># Set up the phonon sub-workchain</span>
        <span class="n">ph_base</span> <span class="o">=</span> <span class="n">PhBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">codes</span><span class="p">[</span><span class="s1">&#39;ph&#39;</span><span class="p">],</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_base</span>

        <span class="n">epw</span> <span class="o">=</span> <span class="n">EpwBaseWorkChain</span><span class="o">.</span><span class="n">get_builder_from_protocol</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">codes</span><span class="p">[</span><span class="s1">&#39;epw&#39;</span><span class="p">],</span>
            <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span>
            <span class="n">overrides</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="n">w90_chk_to_ukk_script</span><span class="o">=</span><span class="n">w90_chk_to_ukk_script</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">builder</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">epw</span><span class="o">.</span><span class="n">_data</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">clean_workdir</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;clean_workdir&#39;</span><span class="p">])</span>
        <span class="c1"># builder._inputs(prune=True)</span>

        <span class="k">return</span> <span class="n">builder</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.setup">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup the work chain.&quot;&quot;&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span>
                <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.generate_reciprocal_points">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.generate_reciprocal_points">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_reciprocal_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the reciprocal points.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;qpoints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">qpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">qpoints</span>
        <span class="k">elif</span> <span class="s1">&#39;qpoints_distance&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;Generating q-points and k-points&#39;</span><span class="p">)</span>

            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">qpoints_distance</span><span class="p">,</span>
                <span class="s1">&#39;force_parity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kpoints_force_parity&#39;</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">)),</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;call_link_label&#39;</span><span class="p">:</span> <span class="s1">&#39;create_qpoints_from_distance&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">qpoints</span> <span class="o">=</span> <span class="n">create_kpoints_from_distance</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">qpoints</span>

        <span class="k">if</span> <span class="s1">&#39;kpoints_factor_nscf&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">qpoints_mesh</span> <span class="o">=</span> <span class="n">qpoints</span><span class="o">.</span><span class="n">get_kpoints_mesh</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kpoints_nscf</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">KpointsData</span><span class="p">()</span>
            <span class="n">kpoints_nscf</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">([</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">kpoints_factor_nscf</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">qpoints_mesh</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">kpoints_nscf</span> <span class="o">=</span> <span class="n">kpoints_nscf</span></div>



<div class="viewcode-block" id="EpwB2WWorkChain.should_run_wannier90">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.should_run_wannier90">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_run_wannier90</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the wannier90 workflow should be run.</span>
<span class="sd">        If &#39;w90_intp&#39; is not in the inputs or the &#39;kpoints_nscf&#39; is not in the context, it will return False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
            <span class="ow">and</span>
            <span class="s1">&#39;kpoints_nscf&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.run_wannier90">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.run_wannier90">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_wannier90</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the wannier90 workflow.&quot;&quot;&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">Wannier90OptimizeWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># TODO: Remove this once we have a better way to handle the kpoints</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">wannier90</span><span class="o">.</span><span class="n">wannier90</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;additional_retrieve_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aiida.chk&#39;</span><span class="p">]</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">wannier90</span><span class="o">.</span><span class="n">wannier90</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">call_link_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span>

        <span class="n">set_kpoints</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">kpoints_nscf</span><span class="p">,</span> <span class="n">Wannier90OptimizeWorkChain</span><span class="p">)</span>

        <span class="c1"># TODO: Remove this once we have a better way to handle the kpoints</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;kpoints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">workchain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">Wannier90OptimizeWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;launching wannier90 work chain </span><span class="si">{</span><span class="n">workchain_node</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_w90_intp</span><span class="o">=</span><span class="n">workchain_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.inspect_wannier90">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.inspect_wannier90">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inspect_wannier90</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the wannier90 workflow finished successfully.</span>
<span class="sd">        If the wannier90 workflow passed, it will generate the parent folders for the phonon and epw workflows and the outputs of the wannier90 workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.utils.overrides</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span>

        <span class="n">workchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_w90_intp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">parent_folder_scf</span> <span class="o">=</span> <span class="n">workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">remote_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_nscf</span> <span class="o">=</span> <span class="n">workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">nscf</span><span class="o">.</span><span class="n">remote_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_chk</span> <span class="o">=</span> <span class="n">get_parent_folder_chk_from_w90_workchain</span><span class="p">(</span><span class="n">workchain</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`Wannier90BandsWorkChain` failed with exit status </span><span class="si">{</span><span class="n">workchain</span><span class="o">.</span><span class="n">exit_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">ERROR_SUB_PROCESS_FAILED_WANNIER90</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_w90_intp</span><span class="p">,</span>
                <span class="n">Wannier90OptimizeWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_W90_NAMESPACE</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.should_run_ph">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.should_run_ph">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">should_run_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the phonon workflow should be run.</span>
<span class="sd">        If &#39;ph_base&#39; is not in the inputs or the &#39;qpoints&#39; is not in the context, it will return False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>
            <span class="ow">and</span>
            <span class="s1">&#39;qpoints&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.run_ph">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.run_ph">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the `PhBaseWorkChain`.&quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed_inputs</span><span class="p">(</span><span class="n">PhBaseWorkChain</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;workchain_w90_intp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">:</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">ph</span><span class="o">.</span><span class="n">parent_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_w90_intp</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">scf</span><span class="o">.</span><span class="n">remote_folder</span>


        <span class="n">inputs</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">qpoints</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">call_link_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_target_base</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">ph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">)</span>
        <span class="n">workchain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">PhBaseWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;launching `ph` </span><span class="si">{</span><span class="n">workchain_node</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_ph</span><span class="o">=</span><span class="n">workchain_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.inspect_ph">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.inspect_ph">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inspect_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the `PhBaseWorkChain` finished successfully.</span>
<span class="sd">        If the phonon workflow passed, it will generate the parent folder for the epw workflow and the outputs of the phonon workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_ph</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">parent_folder_ph</span> <span class="o">=</span> <span class="n">workchain</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Electron-phonon `PhBaseWorkChain` failed with exit status </span><span class="si">{</span><span class="n">workchain</span><span class="o">.</span><span class="n">exit_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">ERROR_SUB_PROCESS_FAILED_PHONON</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_ph</span><span class="p">,</span>
                <span class="n">PhBaseWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_PH_NAMESPACE</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="EpwB2WWorkChain.run_epw">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.run_epw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_epw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the `epw.x` calculation.&quot;&quot;&quot;</span>

        <span class="c1"># inputs = AttributeDict(self.exposed_inputs(EpwCalculation, namespace=&#39;epw&#39;))</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">inputs</span>

        <span class="n">fpoints</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">KpointsData</span><span class="p">()</span>
        <span class="n">fpoints</span><span class="o">.</span><span class="n">set_kpoints_mesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_QFPOINTS</span><span class="p">)</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">qfpoints</span> <span class="o">=</span> <span class="n">fpoints</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">kfpoints_factor</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_KFPOINTS_FACTOR</span><span class="p">)</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">structure</span>

        <span class="n">inputs</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">call_link_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_target_base</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">epw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">)</span>
        <span class="n">workchain_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">EpwBaseWorkChain</span><span class="p">,</span> <span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;launching `epw` </span><span class="si">{</span><span class="n">workchain_node</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ToContext</span><span class="p">(</span><span class="n">workchain_epw</span><span class="o">=</span><span class="n">workchain_node</span><span class="p">)</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.inspect_epw">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.inspect_epw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inspect_epw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the `epw.x` calculation finished successfully.</span>
<span class="sd">        If the epw workflow passed, it will generate the outputs of the epw workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">workchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_epw</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workchain</span><span class="o">.</span><span class="n">is_finished_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`EpwBaseWorkChain` failed with exit status </span><span class="si">{</span><span class="n">workchain</span><span class="o">.</span><span class="n">exit_status</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_codes</span><span class="o">.</span><span class="n">ERROR_SUB_PROCESS_FAILED_EPW</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_many</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exposed_outputs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">workchain_epw</span><span class="p">,</span>
                <span class="n">EpwBaseWorkChain</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_EPW_NAMESPACE</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div>

        <span class="c1">## TODO: If the workchain finished OK, we will clean the remote folder:</span>
        <span class="c1">## rm out/aiida.epb*, out/aiida.wfc*, out/aiida.save/*</span>


<div class="viewcode-block" id="EpwB2WWorkChain.results">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the most important results to the outputs of the work chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span></div>


<div class="viewcode-block" id="EpwB2WWorkChain.on_terminated">
<a class="viewcode-back" href="../../../api_reference/aiida_supercon.workflows.html#aiida_supercon.workflows.b2w.EpwB2WWorkChain.on_terminated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_terminated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean the working directories of all child calculations if `clean_workdir=True` in the inputs.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_terminated</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">clean_workdir</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s1">&#39;remote folders will not be cleaned&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">cleaned_calcs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">called_descendant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">called_descendants</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">called_descendant</span><span class="p">,</span> <span class="n">orm</span><span class="o">.</span><span class="n">CalcJobNode</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">called_descendant</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">remote_folder</span><span class="o">.</span><span class="n">_clean</span><span class="p">()</span>  <span class="c1"># pylint: disable=protected-access</span>
                    <span class="n">cleaned_calcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">called_descendant</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">cleaned_calcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cleaned remote folders of calculations: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">cleaned_calcs</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Marnik Bercx.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>